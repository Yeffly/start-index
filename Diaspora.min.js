var xhr,Home=location.href,Pages=4,xhrUrl="",Diaspora={L:function(e,t,a){if(e==xhrUrl)return!1;xhrUrl=e,xhr&&xhr.abort(),xhr=$.ajax({type:"GET",url:e,timeout:1e4,success:function(e){t(e),xhrUrl=""},error:function(t,i,o){"abort"==i?a&&a():window.location.href=e,xhrUrl=""}})},P:function(){return!!("ontouchstart"in window)},PS:function(){window.history&&history.pushState&&(history.replaceState({u:Home,t:document.title},document.title,Home),window.addEventListener("popstate",function(e){var t=e.state;t&&(document.title=t.t,t.u==Home?($("#preview").css("position","fixed"),setTimeout(function(){$("#preview").removeClass("show").addClass("trans"),$("#container").show(),window.scrollTo(0,parseInt($("#container").data("scroll"))),setTimeout(function(){$("#preview").html(""),$(window).trigger("resize")},300)},0)):(Diaspora.loading(),Diaspora.L(t.u,function(e){document.title=t.t,$("#preview").html($(e).filter("#single")),Diaspora.preview(),setTimeout(function(){Diaspora.player(t.d)},0)})))}))},HS:function(e,t){var a=e.data("id")||0,i=e.attr("href"),o=e.attr("title")||e.text();$("#preview").length&&window.history&&history.pushState||(location.href=i),Diaspora.loading();var s={d:a,t:o,u:i};Diaspora.L(i,function(e){if($(e).filter("#single").length){switch(t){case"push":history.pushState(s,o,i);break;case"replace":history.replaceState(s,o,i)}switch(document.title=o,$("#preview").html($(e).filter("#single")),t){case"push":Diaspora.preview();break;case"replace":window.scrollTo(0,0),Diaspora.loaded()}setTimeout(function(){a||(a=$(".icon-play").data("id")),Diaspora.player(a),$(".content img").each(function(){$(this).attr("src").indexOf("/uploads/2014/downloading.png")>-1&&($(this).hide(),$(".downloadlink").attr("href",$(this).parent().attr("href")))}),"replace"==t&&$("#top").show()},0)}else location.href=i})},preview:function(){setTimeout(function(){$("#preview").addClass("show"),$("#container").data("scroll",window.scrollY),setTimeout(function(){$("#container").hide(),setTimeout(function(){$("#preview").css({position:"static","overflow-y":"auto"}).removeClass("trans"),$("#top").show(),Diaspora.loaded()},500)},300)},0)},player:function(e){var t=$("#audio-"+e+"-1");t.length?(t[0].play(),t.on({timeupdate:function(){$(".bar").css("width",t[0].currentTime/t[0].duration*100+"%")},ended:function(){$(".icon-pause").removeClass("icon-pause").addClass("icon-play")},playing:function(){$(".icon-play").removeClass("icon-play").addClass("icon-pause")}})):$(".icon-play").css({color:"#dedede",cursor:"not-allowed"})},loading:function(){var e=window.innerWidth,t='<style class="loaderstyle" id="loaderstyle'+e+'">@-moz-keyframes loader'+e+"{100%{background-position:"+e+"px 0}}@-webkit-keyframes loader"+e+"{100%{background-position:"+e+"px 0}}.loader"+e+"{-webkit-animation:loader"+e+" 3s linear infinite;-moz-animation:loader"+e+" 3s linear infinite;}</style>";$(".loaderstyle").remove(),$("head").append(t),$("#loader").removeClass().addClass("loader"+e).show()},loaded:function(){$("#loader").removeClass().hide()},F:function(e,t,a){var i=$(e).parent().height(),o=$(e).parent().width(),s=a/t;i/o>s?(e.style.height=i+"px",e.style.width=i/s+"px"):(e.style.width=o+"px",e.style.height=o*s+"px"),e.style.left=(o-parseInt(e.style.width))/2+"px",e.style.top=(i-parseInt(e.style.height))/2+"px"}};$(function(){if(Diaspora.P()&&$("body").addClass("touch"),$("#preview").length){var e,t={};t.t=$("#cover"),t.w=t.t.attr("width"),t.h=t.t.attr("height"),(t.o=function(){$("#mark").height(window.innerHeight)})(),t.t.prop("complete")&&setTimeout(function(){t.t.load()},0),t.t.on("load",function(){(t.f=function(){var e,a,i,o,s=$("#mark").width(),n=$("#mark").height();o=s>=1e3||n>=1e3?1e3:500,s>=n?(i=s/o*50,a=i,e=i*s/n):(i=n/o*50,e=i,a=i*n/s),$(".layer").css({width:s+e,height:n+a,marginLeft:-.5*e,marginTop:-.5*a}),t.w||(t.w=t.t.width(),t.h=t.t.height()),Diaspora.F($("#cover")[0],t.w,t.h)})(),setTimeout(function(){$("html, body").removeClass("loading")},1e3),$("#mark").parallax();var e=new Vibrant(t.t[0]),a=e.swatches();a.DarkVibrant&&($("#vibrant polygon").css("fill",a.DarkVibrant.getHex()),$("#vibrant div").css("background-color",a.DarkVibrant.getHex())),a.Vibrant&&$(".icon-menu").css("color",a.Vibrant.getHex())}),t.t.attr("src")||alert("Please set the post thumbnail"),$("#preview").css("min-height",window.innerHeight),Diaspora.PS(),$(".pview a").addClass("pviewa"),$(window).on("resize",function(){clearTimeout(e),e=setTimeout(function(){Diaspora.P()||location.href!=Home||(t.o(),t.f()),$("#loader").attr("class")&&Diaspora.loading()},500)})}else $("#single").css("min-height",window.innerHeight),$("html, body").removeClass("loading"),window.addEventListener("popstate",function(e){e.state&&(location.href=e.state.u)}),Diaspora.player($(".icon-play").data("id")),$(".icon-icon, .image-icon").attr("href","/"),$(".content img").each(function(){$(this).attr("src").indexOf("/uploads/2014/downloading.png")>-1&&($(this).hide(),$(".downloadlink").attr("href",$(this).parent().attr("href")).css("display","block"))}),$("#top").show();$(window).on("scroll",function(){if($(".scrollbar").length&&!Diaspora.P()&&!$(".icon-images").hasClass("active")){var e=$(window).scrollTop(),t=$(".content").height();e>t&&(e=t),$(".scrollbar").width((50+e)/t*100+"%"),e>80&&window.innerWidth>800?$(".subtitle").fadeIn():$(".subtitle").fadeOut()}}),$(window).on("touchmove",function(e){$("body").hasClass("mu")&&e.preventDefault()}),$("body").on("click",function(e){var t=$(e.target).attr("class")||"",a=$(e.target).attr("rel")||"";if(t||a)switch(!0){case-1!=t.indexOf("switchmenu"):window.scrollTo(0,0),$("html, body").toggleClass("mu");break;case-1!=t.indexOf("more"):if(t=$(".more"),"loading"==t.data("status"))return!1;var i=parseInt(t.data("page"))||1;if(1==i&&t.data("page",1),i>=Pages)return;return t.html("加载中..").data("status","loading"),Diaspora.loading(),Diaspora.L(t.attr("href"),function(e){var a=$(e).find(".more").attr("href");null!=a?(t.attr("href",a).html("加载更多").data("status","loaded"),t.data("page",parseInt(t.data("page"))+1)):$("#pager").remove();var i=$(window).scrollTop();$("#primary").append($(e).find(".post")),$(window).scrollTop(i),Diaspora.loaded(),$("html,body").animate({scrollTop:i+400},500)},function(){t.html("加载更多").data("status","loaded")}),!1;case-1!=t.indexOf("icon-images"):window.scrollTo(0,0);var o=$(".icon-images");if("loading"==o.data("status"))return!1;if(o.hasClass("active"))o.removeClass("active"),$(".article").css("height","auto"),$(".section").css("left","-100%"),setTimeout(function(){$(".images").data("height",$(".images").height()).css("height","0")},0);else if(o.addClass("active"),$(".images").css("height",$(".images").data("height")),$(".icon-images").hasClass("tg"))$(".section").css("left",0),setTimeout(function(){$(".article").css("height","0")},0);else{Diaspora.P()&&window.innerWidth<700||$(".zoom").Chocolat(),Diaspora.loading(),o.data("status","loading");var s=5,n=120;Diaspora.P()&&window.innerWidth<600&&(s=1,n=80),$("#jg").justifiedGallery({margins:s,rowHeight:n}).on("jg.complete",function(){$(".section").css("left",0),$(".icon-images").addClass("tg"),o.data("status",""),Diaspora.loaded(),setTimeout(function(){$(".article").css("height","0")},0)})}break;case-1!=t.indexOf("icon-wechat"):$(".icon-wechat").hasClass("tg")?$("#qr").toggle():($(".icon-wechat").addClass("tg"),$("#qr").qrcode({width:128,height:128,text:location.href}).toggle());break;case-1!=t.indexOf("icon-play"):$("#audio-"+$(".icon-play").data("id")+"-1")[0].play(),$(".icon-play").removeClass("icon-play").addClass("icon-pause");break;case-1!=t.indexOf("icon-pause"):$("#audio-"+$(".icon-pause").data("id")+"-1")[0].pause(),$(".icon-pause").removeClass("icon-pause").addClass("icon-play");break;case-1!=t.indexOf("icon-like"):var r=$(e.target).parent(),l=r.attr("class");if(r.prev().hasClass("icon-view"))return;if(l=l.split(" "),"active"==l[1])return;r.addClass("active");var c=r.attr("id").split("like-");$.ajax({type:"POST",url:"/index.php",data:"likepost="+c[1],success:function(){var e=$("#like-"+c[1]).html(),t=/(\d)+/,a=t.exec(e);a[0]++,$("#like-"+c[1]).html('<span class="icon-like"></span><span class="count">'+a[0]+"</span>")}});break;case-1!=t.indexOf("cover"):return Diaspora.HS($(e.target).parent(),"push"),!1;case-1!=t.indexOf("posttitle"):return Diaspora.HS($(e.target),"push"),!1;case-1!=t.indexOf("relatea"):return Diaspora.HS($(e.target),"replace"),!1;case-1!=t.indexOf("relateimg"):return Diaspora.HS($(e.target).parent(),"replace"),!1;case"prev"==a||"next"==a:if("prev"==a)r=$("#prev_next a")[0].text;else r=$("#prev_next a")[1].text;return $(e.target).attr("title",r),Diaspora.HS($(e.target),"replace"),!1;case-1!=t.indexOf("pviewa"):return $("body").removeClass("mu"),setTimeout(function(){Diaspora.HS($(e.target),"push")},300),!1;default:return}})});